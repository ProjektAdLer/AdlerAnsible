---

- name: base packages
  ansible.builtin.apt:
    name: "{{ common_system_packages | default([]) }}"
    update_cache: yes
    cache_valid_time: 86400 # 1 day

- name: ensure ansible user exists
  ansible.builtin.include_role:
    name: ../roles/user_management
  vars:
    user_management_users:
      - username: "ansible"
        password_hash: "{{ common_user_password_hash_ansible }}"
        groups: sudo
        update_password: true
        ssh_pubkey: "{{ common_user_ssh_pubkey_ansible }}"
        ssh_pubkey_replace: true

- block:
    - name: Disable SSH login for root user
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present

    - name: Ensure SSH key authentication is enabled
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PubkeyAuthentication'
        line: 'PubkeyAuthentication yes'
        state: present

    - name: Disable password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present

  notify: restart_ssh_service