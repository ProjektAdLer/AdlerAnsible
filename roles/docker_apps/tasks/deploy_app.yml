- name: "{{ docker_apps_project.name }} | Stop and remove compose project"
  when: docker_apps_project.state | default('present') == 'absent'
  block:
    - name: "{{ docker_apps_project.name }} | Stop docker compose project"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_apps_base_path }}/{{ docker_apps_project.name }}"
        state: absent

    - name: "{{ docker_apps_project.name }} | Remove application directories"
      ansible.builtin.file:
        path: "{{ docker_apps_base_path }}/{{ docker_apps_project.name }}"
        state: absent

- name: "{{ docker_apps_project.name }} | Deploy docker compose project"
  when: docker_apps_project.state | default('present') == 'present'
  block:
  - name: "{{ docker_apps_project.name }} | Create application directories"
    ansible.builtin.file:
      path: "{{ docker_apps_base_path }}/{{ docker_apps_project.name }}"
      state: directory
      owner: root
      group: root
      mode: 0755

  - name: "{{ docker_apps_project.name }} | Upload files"
    ansible.builtin.include_tasks: upload_app_files.yml
    vars:
      docker_apps_app_name: "{{ docker_apps_project.name }}"
      docker_apps_app_env_vars: "{{ docker_apps_project.env_vars | default({}) }}"
      docker_apps_app_source_path: "{{ docker_apps_source_path + '/' + docker_apps_app_name }}"

  - name: "{{ docker_apps_project.name }} | (Re)start docker compose project"
    community.docker.docker_compose_v2:
      project_src: "{{ docker_apps_base_path }}/{{ docker_apps_project.name }}"
      state: restarted
    when: upload_result is changed
  - name: "{{ docker_apps_project.name }} | Ensure docker compose project is started"
    community.docker.docker_compose_v2:
      project_src: "{{ docker_apps_base_path }}/{{ docker_apps_project.name }}"
      state: present

  - name: "{{ docker_apps_project.name }} | Update"
    when: docker_apps_update_containers
    community.docker.docker_compose_v2:
      project_src: "{{ docker_apps_base_path }}/{{ docker_apps_project.name }}"
      pull: yes
      state: restarted

