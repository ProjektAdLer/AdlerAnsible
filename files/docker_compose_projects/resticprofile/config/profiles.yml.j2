version: "1"

global:
  scheduler: crond
  priority: low
  default-command: snapshots
  min-memory: 100
  initialize: false

default:
  full-backup:
    - local
    - ab

local:
  repository: /host/media/bigdata/restic/docker
  password-file: /etc/resticprofile/passwords/local.txt

{% if docker_apps_project.env_vars.host_prometheus_textfile_collector_path %}
  prometheus-save-to-file: /metrics/restic_local_backup.prom
{% endif %}

  backup:
    source:
      - /host/media/bigdata/docker/volumes
      - /host{{ docker_apps_base_path }}
    exclude:
      # prevent recursive backup of restic files
      - "resticprofile"
    tag:
      - docker_backup
    schedule: "*-*-* 03,15:14:00"
    schedule-permission: system
    force-inactive-lock: true

  retention:
    after-backup: true
    path: false
    group-by: "host"
    keep-last: 2
    keep-daily: 7
    keep-weekly: 4
    keep-monthly: 12
    keep-yearly: 3
    prune: true

ab:
  repository: "rest:https://{{docker_apps_project.env_vars.repos.ab.rest_repo_url}}"
  password-file: /etc/resticprofile/passwords/ab.txt

{% if docker_apps_project.env_vars.host_prometheus_textfile_collector_path %}
  prometheus-save-to-file: /metrics/restic_ab_backup.prom
{% endif %}

  env:
    RESTIC_REST_USERNAME: "{{ docker_apps_project.env_vars.repos.ab.rest_username }}"
    RESTIC_REST_PASSWORD: "{{ docker_apps_project.env_vars.repos.ab.rest_password }}"

  backup:
    source:
      - /host/media/bigdata/docker/volumes/adler_*
    tag:
      - docker_backup
    schedule: "daily"
    schedule-permission: system
    force-inactive-lock: true

# host does not allow snapshot deletion
#  retention:
#    keep-last: 2
#    keep-daily: 7
#    keep-weekly: 4
#    keep-monthly: 12
#    keep-yearly: 3
#    prune: true