---
- name: Main Adler Server specific playbook
  hosts: main_server
  become: yes
  tasks:
    - name: Install restic
      ansible.builtin.package:
        name: restic
        state: present
        cache_valid_time: 86400

    - name: restic backup
      include_role:
        name: roles-ansible.restic
      vars:
        restic_repos:
          local:
            location: /media/bigdata/restic/docker
            password: "{{ backup_secrets.local.encryption_password }}"
          ab:
            location: "rest:https://{{backup_config.ab.rest_username}}:{{backup_secrets.ab.rest_password}}@{{backup_config.ab.rest_repo_url}}"
            password: "{{ backup_secrets.ab.encryption_password }}"
        restic_backups:
          - name: "docker_backup"
            repo: local
            src: "/media/bigdata/docker /opt/docker-apps"
            keep_last: 2
            keep_daily: 7
            keep_weekly: 4
            keep_monthly: 12
            keep_yearly: 3
            prune: true
            scheduled: true
          - name: "ab_docker_backup"
            repo: ab
            src: "/media/bigdata/docker/volumes/adler_*"
            keep_last: 2
            keep_daily: 7
            keep_weekly: 4
            keep_monthly: 12
            keep_yearly: 3
            prune: true
            scheduled: true
#            exclude:
#              - "/media/bigdata/docker/volumes/*"
#              - "!/media/bigdata/docker/volumes/adler_*"
        restic_create_schedule: true
        restic__max_cpus: 16

    - name: Docker projects
      block:
        - name: Install docker package
          ansible.builtin.package:
            name: docker.io
            state: present
            cache_valid_time: 3600

        - name: Create docker network
          ansible.builtin.docker_network:
            name: traefik_gateway
            state: present
            driver: bridge

        - name: Deploy docker apps
          include_role:
            name: ../roles/docker_apps
          vars:
            docker_apps_base_path: /opt/docker-apps
            docker_apps_projects:
              - name: bugreports
                state: present
                env_vars:
                  webhookurl: "{{ docker_secrets.bugreports.webhookurl }}"
              - name: ea-download
                state: present
                env_vars:
                  postgres_password: "{{ docker_secrets.ea_download.postgres_password }}"
              - name: github_runner
                state: present
                env_vars:
                  github_runner_token: "{{ docker_secrets.github_runner.github_runner_token }}"
              - name: nextcloud
                state: present
                env_vars:
                  mysql_root_password: "{{ docker_secrets.nextcloud.mysql_root_password }}"
                  mysql_password: "{{ docker_secrets.nextcloud.mysql_password }}"
              - name: package-registry
                state: present
                env_vars:
                  upload_password: "{{ docker_secrets.package_registry.upload_password }}"
              - name: portainer
                state: present
              - name: traefik
                state: present
              - name: wikijs
                state: present
